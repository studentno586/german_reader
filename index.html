<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Philosophia</title>

    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Philosophia">
    <meta name="theme_color" content="#0a0a0a">
    
    <!-- Dynamic Icons -->
    <link rel="apple-touch-icon" id="app-icon-ios" href="">
    <link rel="icon" id="app-icon-fav" href="">
    <link rel="manifest" id="manifest-placeholder">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;700&family=Noto+Serif+JP:wght@300;400;500&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #0a0a0a;
            --text-main: #e0e0e0;
            --text-sub: #888888;
            --accent-color: #d4af37; /* Antique Gold */
            --border-color: #333333;
            --card-bg: #111111;
            --status-passed: #2e7d32;
            --status-review: #c62828;
            --sidebar-width: 280px;
            --header-height: 60px;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Noto Serif JP', serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            overscroll-behavior-y: none;
            letter-spacing: 0.05em;
        }

        /* --- Splash Screen (No Icon) --- */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #050505;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.8s ease-out, visibility 0.8s;
        }
        
        #splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .splash-title {
            font-family: 'Cinzel', serif;
            font-size: 2.2rem;
            color: var(--text-main);
            letter-spacing: 0.25em;
            margin-bottom: 10px;
            text-align: center;
            animation: fadeUp 1s ease-out;
        }

        .splash-subtitle {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.8rem;
            color: var(--accent-color);
            letter-spacing: 0.3em;
            text-transform: uppercase;
            animation: fadeUp 1.2s ease-out;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: #050505;
            color: white;
            padding-top: calc(40px + var(--safe-area-top));
            position: fixed;
            height: 100%;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border-right: 1px solid var(--border-color);
        }
        
        .sidebar-header { 
            padding: 0 30px 40px; 
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }
        
        /* Sidebar Icon (Gold) */
        .sidebar-icon {
            width: 50px;
            height: 50px;
            margin: 0 auto 15px;
            background-color: var(--accent-color);
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z'/%3E%3C/svg%3E") no-repeat center / contain;
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z'/%3E%3C/svg%3E") no-repeat center / contain;
        }

        .sidebar-header h2 { font-family: 'Cinzel', serif; font-size: 1.3rem; margin: 0; color: var(--text-main); letter-spacing: 0.15em; font-weight: 400; }
        .sidebar-header span { font-family: 'Montserrat', sans-serif; font-size: 0.65rem; color: var(--text-sub); display: block; margin-top: 8px; text-transform: uppercase; letter-spacing: 0.2em; }
        
        /* Search Button */
        .sidebar-search-btn {
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 12px; 
            margin: 0 35px 40px; 
            padding: 12px 0; 
            background: transparent; 
            border: 1px solid rgba(255, 255, 255, 0.15); 
            border-radius: 1px; 
            color: rgba(255, 255, 255, 0.8); 
            font-family: 'Cinzel', serif; 
            font-size: 0.6rem; 
            cursor: pointer; 
            transition: all 0.4s ease; 
            letter-spacing: 0.25em; 
            text-transform: uppercase;
        }
        
        .sidebar-search-btn svg { width: 12px; height: 12px; opacity: 0.8; fill: none; stroke: currentColor; }
        .sidebar-search-btn:hover { border-color: rgba(255, 255, 255, 0.5); color: #fff; background: rgba(255, 255, 255, 0.05); letter-spacing: 0.35em; }

        .nav-item { padding: 16px 30px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 15px; font-family: 'Montserrat', sans-serif; font-size: 0.8rem; color: var(--text-sub); position: relative; letter-spacing: 0.05em; }
        .nav-item:hover, .nav-item.active { color: var(--text-main); }
        .nav-item.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 3px; height: 100%; background: var(--accent-color); }
        
        .close-sidebar-btn { display: none; position: absolute; top: var(--safe-area-top); right: 15px; background: none; border: none; color: white; font-size: 1.5rem; padding: 10px; cursor: pointer; }

        /* Main Content */
        .main-content { margin-left: var(--sidebar-width); flex: 1; padding: 60px 50px; width: 100%; transition: margin-left 0.3s; padding-bottom: calc(100px + var(--safe-area-bottom)); }

        /* Mobile Header */
        .mobile-header { display: none; position: fixed; top: 0; left: 0; width: 100%; height: calc(var(--header-height) + var(--safe-area-top)); padding-top: var(--safe-area-top); background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(10px); z-index: 900; align-items: center; justify-content: space-between; padding-left: 20px; padding-right: 20px; border-bottom: 1px solid var(--border-color); }
        .mobile-title { font-family: 'Cinzel', serif; font-size: 1rem; color: var(--text-main); letter-spacing: 0.1em; }
        .menu-toggle { background: none; border: none; color: var(--text-main); padding: 5px; cursor: pointer; }

        /* Typography */
        header { text-align: left; margin-bottom: 60px; position: relative; animation: fadeIn 1s ease; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
        h1 { font-family: 'Cinzel', serif; color: var(--text-main); font-size: 2.2rem; margin-bottom: 10px; line-height: 1.2; font-weight: 400; letter-spacing: 0.05em; }
        .subtitle { font-family: 'Noto Serif JP', serif; font-size: 0.9rem; color: var(--accent-color); letter-spacing: 0.05em; margin-top: 10px; }

        /* FAB Menu */
        .fab-container { position: fixed; bottom: calc(40px + var(--safe-area-bottom)); right: 40px; z-index: 800; display: flex; flex-direction: column-reverse; align-items: center; gap: 20px; }
        
        .fab-main { 
            width: 64px; 
            height: 64px; 
            border-radius: 50%; 
            background: #000; 
            border: 1px solid var(--accent-color); 
            color: var(--accent-color); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.5rem; 
            cursor: pointer; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        
        .fab-main:active { transform: scale(0.95); }
        .fab-main:hover { background: var(--accent-color); color: #000; }
        
        /* FAB active state rotation */
        .fab-container.active .fab-main {
            transform: rotate(45deg);
            background: var(--accent-color);
            color: #000;
        }

        .fab-sub { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            background: var(--card-bg); 
            border: 1px solid var(--border-color); 
            color: var(--text-main); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.1rem; 
            cursor: pointer; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); 
            opacity: 0; 
            transform: translateY(20px); 
            pointer-events: none; 
            transition: all 0.3s; 
        }
        
        /* Show sub buttons when container is active */
        .fab-container.active .fab-sub { opacity: 1; transform: translateY(0); pointer-events: auto; }
        
        .fab-sub:hover { border-color: var(--accent-color); color: var(--accent-color); }
        .fab-sub:nth-child(2) { transition-delay: 0.05s; }
        .fab-sub:nth-child(3) { transition-delay: 0.1s; }
        .fab-sub:nth-child(4) { transition-delay: 0.15s; }

        /* Icon Eye */
        .icon-eye { width: 24px; height: 24px; fill: none; stroke: #e0e0e0; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; }

        /* Parallel Text */
        .parallel-section { display: flex; flex-direction: column; gap: 50px; max-width: 800px; margin: 0 auto; }
        .sentence-group { position: relative; padding-left: 25px; border-left: 1px solid var(--border-color); transition: all 0.3s ease; animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) both; }
        .sentence-group:hover, .sentence-group.active { border-left-color: var(--accent-color); padding-left: 30px; }
        .sentence-group.passed { border-left-color: var(--status-passed); }
        .sentence-group.passed::before { content: 'âœ“'; position: absolute; left: -25px; top: 0; color: var(--status-passed); font-size: 0.8rem; background: #000; padding: 2px; }
        .sentence-group.failed { border-left-color: var(--status-review); }
        .sentence-group.failed::before { content: '!'; position: absolute; left: -25px; top: 0; color: var(--status-review); font-size: 0.8rem; background: #000; padding: 2px 5px; }

        .de-text-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; margin-bottom: 15px; }
        .de-text { font-family: 'Montserrat', sans-serif; font-weight: 300; font-size: 1.15rem; line-height: 1.7; color: var(--text-main); flex: 1; letter-spacing: 0.02em; }
        .btn-speak { background: none; border: 1px solid var(--border-color); border-radius: 50%; width: 30px; height: 30px; color: var(--text-sub); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 0.8rem; }
        .btn-speak:hover { border-color: var(--accent-color); color: var(--accent-color); }
        
        /* Japanese Text & Hidden Mode Logic */
        .ja-text { 
            font-family: 'Noto Serif JP', serif; 
            font-size: 0.95rem; 
            line-height: 2.2; 
            color: var(--text-sub); 
            margin-bottom: 15px; 
            transition: all 0.4s ease;
        }
        
        body.hidden-mode .ja-text { color: transparent; text-shadow: 0 0 15px rgba(255, 255, 255, 0.3); user-select: none; cursor: pointer; filter: blur(4px); }
        body.hidden-mode .ja-text:hover { text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); filter: blur(2px); }
        body.hidden-mode .ja-text.revealed { color: var(--text-sub); text-shadow: none; filter: blur(0); }

        #hidden-mode-indicator { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.8); color: var(--accent-color); padding: 8px 16px; border: 1px solid var(--accent-color); border-radius: 4px; font-size: 0.75rem; font-family: 'Montserrat', sans-serif; z-index: 999; display: none; pointer-events: none; letter-spacing: 0.1em; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        body.hidden-mode #hidden-mode-indicator { display: block; }

        .action-row { display: flex; gap: 20px; margin-top: 20px; opacity: 0.6; transition: opacity 0.3s; }
        .sentence-group:hover .action-row { opacity: 1; }
        .btn-action-minimal { background: transparent; border: none; color: var(--text-sub); font-family: 'Montserrat', sans-serif; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.15em; cursor: pointer; padding: 0; display: flex; align-items: center; gap: 6px; transition: all 0.3s; }
        .btn-action-minimal:hover { color: var(--accent-color); }

        .note-area { margin-top: 20px; display: none; }
        .note-area.visible { display: block; animation: fadeIn 0.3s ease; }
        .note-input { width: 100%; background: #111; border: 1px solid var(--border-color); color: var(--text-main); padding: 15px; font-family: 'Noto Serif JP', serif; font-size: 0.9rem; border-radius: 0; resize: vertical; min-height: 80px; line-height: 1.8; }
        .note-input:focus { outline: none; border-color: var(--accent-color); }

        .ai-analysis { margin-top: 25px; background: #111; border-top: 1px solid var(--accent-color); padding: 25px; display: none; font-size: 0.9rem; line-height: 1.8; color: #ccc; position: relative; }
        .ai-analysis::before { content: 'AI TUTOR'; position: absolute; top: -10px; left: 20px; background: #000; padding: 0 10px; color: var(--accent-color); font-family: 'Cinzel', serif; font-size: 0.7rem; }
        .ai-analysis.visible { display: block; animation: fadeIn 0.5s ease; }
        .ai-analysis h3 { font-family: 'Montserrat', sans-serif; font-size: 0.75rem; color: var(--text-main); text-transform: uppercase; letter-spacing: 0.15em; margin-top: 25px; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; display: inline-block; }
        .ai-analysis h3:first-child { margin-top: 0; }
        .ai-analysis ul { padding-left: 15px; list-style-type: square; color: var(--text-sub); }
        .ai-analysis code { color: var(--accent-color); font-family: 'Montserrat', sans-serif; font-size: 0.9em; }

        .vocab-section { margin-top: 120px; border-top: 1px solid var(--border-color); padding-top: 50px; }
        .vocab-section h2 { font-family: 'Cinzel', serif; font-size: 1.2rem; color: var(--text-main); margin-bottom: 40px; letter-spacing: 0.1em; font-weight: 400; text-align: center; }
        .vocab-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 30px; }
        .vocab-item { padding: 15px; border: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 8px; transition: border-color 0.3s; text-align: center; }
        .vocab-item:hover { border-color: var(--accent-color); }
        .vocab-de { font-family: 'Montserrat', sans-serif; font-size: 0.95rem; color: var(--text-main); font-weight: 500; }
        .vocab-ja { font-size: 0.85rem; color: var(--text-sub); font-family: 'Noto Serif JP', serif; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 2000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.active { opacity: 1; }
        .modal-content { background: #050505; width: 100%; height: 100%; padding: 50px; overflow-y: auto; position: relative; display: flex; flex-direction: column; }
        .modal-header { margin-bottom: 40px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-family: 'Cinzel', serif; font-size: 1.8rem; margin: 0; color: var(--text-main); letter-spacing: 0.1em; }
        .close-modal-btn { background: none; border: 1px solid var(--border-color); color: var(--text-main); width: 50px; height: 50px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .close-modal-btn:hover { border-color: var(--accent-color); color: var(--accent-color); transform: rotate(90deg); }
        .search-input, .chat-input, .translation-input { width: 100%; background: #111; border: 1px solid var(--border-color); color: var(--text-main); padding: 20px; font-size: 1rem; border-radius: 0; font-family: 'Noto Serif JP', serif; transition: border-color 0.3s; }
        .search-input:focus, .chat-input:focus, .translation-input:focus { outline: none; border-color: var(--accent-color); }
        .search-results { margin-top: 30px; display: flex; flex-direction: column; gap: 15px; }
        .search-result-item { padding: 20px; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s; }
        .search-result-item:hover { border-color: var(--accent-color); background: #111; }
        .result-source { font-family: 'Cinzel', serif; font-size: 0.7rem; color: var(--accent-color); margin-bottom: 8px; letter-spacing: 0.1em; }
        .chat-container { flex: 1; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; padding-bottom: 30px; }
        .chat-message { max-width: 80%; padding: 20px; border: 1px solid var(--border-color); font-size: 0.95rem; line-height: 1.8; }
        .chat-message.user { align-self: flex-end; border-color: var(--text-sub); color: var(--text-main); }
        .chat-message.ai { align-self: flex-start; border-color: var(--accent-color); color: #ccc; }
        .chat-input-area { margin-top: auto; display: flex; gap: 15px; border-top: 1px solid var(--border-color); padding-top: 30px; }
        .chat-send-btn, .btn-grade { background: var(--text-main); color: #000; border: none; padding: 0 30px; font-family: 'Montserrat', sans-serif; font-weight: 600; letter-spacing: 0.1em; cursor: pointer; transition: all 0.3s; }
        .chat-send-btn:hover, .btn-grade:hover { background: var(--accent-color); }
        .quiz-card { margin-bottom: 50px; }
        .source-text { font-family: 'Montserrat', sans-serif; font-size: 1.2rem; color: var(--text-main); margin-bottom: 25px; line-height: 1.6; border-left: 3px solid var(--accent-color); padding-left: 20px; }
        textarea.translation-input { height: 150px; resize: none; margin-bottom: 20px; }
        .btn-grade { padding: 15px 40px; width: auto; display: inline-block; }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 100%; border-right: none; background: #0a0a0a; }
            .sidebar.open { transform: translateX(0); }
            .close-sidebar-btn { display: block; }
            .mobile-header { display: flex; }
            .main-content { margin-left: 0; padding: 30px 25px; padding-top: calc(var(--header-height) + var(--safe-area-top) + 30px); }
            h1 { font-size: 1.8rem; }
            .parallel-section { gap: 40px; }
            .de-text { font-size: 1.05rem; }
            .fab-container { bottom: calc(25px + var(--safe-area-bottom)); right: 25px; }
            .modal-content { padding: 25px; padding-top: calc(var(--safe-area-top) + 30px); }
            .modal-header h2 { font-size: 1.4rem; }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 2px solid #333; border-radius: 50%; border-top: 2px solid var(--text-main); width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <script>
        // Generate Dynamic Icon (Gold Head Icon)
        const iconSvg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%230a0a0a'/><path d='M256 64c-88.4 0-160 71.6-160 160 0 38.8 13.8 74.4 36.8 102.6-6.1 13-13.6 25.1-2.2 24.1 8.7 38.6 35.1 33.6 60.1-2.9 14.3 1.9 29.1 12.8 38.8 18.7 16.7 21.6 45 6.6 65.1-13 17.4-13 41.2 0 58.6 15 20.1 12.1 48.4-6.6 65.1-10.9 9.8-15.7 24.5-12.8 38.8 5 25-9.5 51.4-33.6 60.1-8.4 3-17.4 2.1-25.1-2.2-18.5-10.3-41.1-5.2-53.1 12.5C335.9 490.2 298.5 512 256 512c-141.4 0-256-114.6-256-256S114.6 0 256 0zm0 128c-70.7 0-128 57.3-128 128s57.3 128 128 128 128-57.3 128-128-57.3-128-128-128zm-32 96c0-17.7 14.3-32 32-32s32 14.3 32 32-14.3 32-32 32-32-14.3-32-32zm32 112c-29.3 0-55.2-13.7-71.3-34.9 8.2-7.3 18.7-11.8 30.3-12.7 11.2-.9 22.5 3.3 30.6 11.4 6 6 14.1 9.4 22.7 9.4 23.3 0 43.1-16.1 48.3-39.2 1.4-6.1 7.6-9.9 13.7-8.5 6.1 1.4 9.9 7.6 8.5 13.7C330.4 316.3 296 336 256 336z' fill='%23d4af37'/></svg>`;
        const iconUrl = `data:image/svg+xml;base64,${btoa(iconSvg)}`;
        
        document.getElementById('app-icon-ios').href = iconUrl;
        document.getElementById('app-icon-fav').href = iconUrl;

        const manifest = {
            "name": "Philosophia",
            "short_name": "Philosophia",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#0a0a0a",
            "theme_color": "#0a0a0a",
            "icons": [
                {
                    "src": iconUrl,
                    "sizes": "192x192",
                    "type": "image/svg+xml"
                },
                {
                    "src": iconUrl,
                    "sizes": "512x512",
                    "type": "image/svg+xml"
                }
            ]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.querySelector('#manifest-placeholder').setAttribute('href', manifestURL);
    </script>
</head>
<body>

<div id="splash-screen">
    <h1 class="splash-title">PHILOSOPHIA</h1>
    <span class="splash-subtitle">GERMAN IDEALISM READER</span>
</div>

<!-- Indicator for Hidden Mode -->
<div id="hidden-mode-indicator">
    <svg class="icon-eye" viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
    HIDDEN MODE ACTIVE
</div>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<div class="mobile-header">
    <button class="menu-toggle" onclick="toggleSidebar()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>
    <div class="mobile-title" id="mobile-title">PHILOSOPHIA</div>
    <div style="width:24px;"></div>
</div>

<div class="sidebar" id="sidebar">
    <button class="close-sidebar-btn" onclick="closeSidebar()">âœ•</button>
    <div class="sidebar-header">
        <div class="sidebar-icon"></div>
        <h2>PHILOSOPHIA</h2>
        <span>German Idealism Reader</span>
    </div>
    
    <!-- New Stylish Search Button -->
    <button class="sidebar-search-btn" onclick="openSearchModal()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        SEARCH TEXTS
    </button>

    <div class="nav-item active" onclick="loadContent('reinhold')"><span>06. REINHOLD</span></div>
    <div class="nav-item" onclick="loadContent('fichte')"><span>07. FICHTE</span></div>
    <div class="nav-item" onclick="loadContent('schelling')"><span>08. SCHELLING</span></div>
    <div class="nav-item" onclick="loadContent('hegel')"><span>09. HEGEL</span></div>
    <div class="nav-item" onclick="loadContent('hegel_logik')"><span>10. HEGEL (LOGIK)</span></div>
</div>

<!-- FAB Menu -->
<div class="fab-container" id="fabContainer" onclick="toggleFab()">
    <div class="fab-main">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </div>
    <!-- New Hidden Mode Toggle Button with Monochrome Eye SVG -->
    <div class="fab-sub" onclick="toggleHiddenMode(); event.stopPropagation();">
        <svg class="icon-eye" id="icon-eye-toggle" viewBox="0 0 24 24">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
        </svg>
    </div>
    <div class="fab-sub" onclick="openChatModal(); event.stopPropagation();">ğŸ’¬</div>
    <div class="fab-sub" onclick="generateTranslationQuiz(); event.stopPropagation();">âœ</div>
</div>

<div class="main-content">
    <header>
        <h1 id="doc-title">REINHOLD</h1>
        <div class="subtitle" id="doc-subtitle">BeitrÃ¤ge zur Berichtigung</div>
    </header>

    <div class="parallel-section" id="parallelText"></div>

    <div class="vocab-section">
        <h2>VOCABULARY</h2>
        <div class="vocab-grid" id="vocabGrid"></div>
    </div>
</div>

<!-- Quiz Modal -->
<div id="quizModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2>TRANSLATION QUIZ</h2>
            <button class="close-modal-btn" onclick="closeModal('quizModal')">âœ•</button>
        </div>
        <div id="quizContainer"></div>
    </div>
</div>

<!-- Chat Modal -->
<div id="chatModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ASK PHILOSOPHER</h2>
            <button class="close-modal-btn" onclick="closeModal('chatModal')">âœ•</button>
        </div>
        <div class="chat-container" id="chatContainer">
            <div class="chat-message ai">
                ã“ã‚“ã«ã¡ã¯ã€‚ãƒ‰ã‚¤ãƒ„è¦³å¿µè«–ã«ã¤ã„ã¦ã€ä½•ã‹è³ªå•ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" class="chat-input" placeholder="è³ªå•ã‚’å…¥åŠ›...">
            <button class="chat-send-btn" onclick="sendMessage()">SEND</button>
        </div>
    </div>
</div>

<!-- Search Modal -->
<div id="searchModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2>SEARCH</h2>
            <button class="close-modal-btn" onclick="closeModal('searchModal')">âœ•</button>
        </div>
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ä¾‹: è‡ªæˆ‘, Geist)..." onkeyup="performSearch()">
            <div id="searchResults" class="search-results"></div>
        </div>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    const apiKey = "AIzaSyAtJXMs2gU7WqR-bL684FfXnxktTThwc-4"; // Provided by user previously
    const genAI = new GoogleGenerativeAI(apiKey);
    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-09-2025" });

    // --- Splash Screen Logic ---
    window.addEventListener('load', () => {
        setTimeout(() => {
            const splash = document.getElementById('splash-screen');
            splash.classList.add('hidden');
            setTimeout(() => splash.style.display = 'none', 800);
        }, 0); 
    });

    // --- Local Storage Management ---
    const STORAGE_KEY_PROGRESS = 'german_reader_progress_classic';
    const STORAGE_KEY_NOTES = 'german_reader_notes_classic';

    function getProgress() {
        const data = localStorage.getItem(STORAGE_KEY_PROGRESS);
        return data ? JSON.parse(data) : {};
    }

    function saveProgress(docId, sentenceIndex, score) {
        const progress = getProgress();
        if (!progress[docId]) progress[docId] = {};
        progress[docId][sentenceIndex] = {
            score: score,
            timestamp: Date.now(),
            isPassed: score >= 80
        };
        localStorage.setItem(STORAGE_KEY_PROGRESS, JSON.stringify(progress));
    }

    function getNotes() {
        const data = localStorage.getItem(STORAGE_KEY_NOTES);
        return data ? JSON.parse(data) : {};
    }

    function saveNote(docId, sentenceIndex, text) {
        const notes = getNotes();
        if (!notes[docId]) notes[docId] = {};
        notes[docId][sentenceIndex] = text;
        localStorage.setItem(STORAGE_KEY_NOTES, JSON.stringify(notes));
    }

    // --- Data Structure ---
    const allData = {
        reinhold: {
            title: "REINHOLD",
            subtitle: "BeitrÃ¤ge zur Berichtigung (1790)",
            sentences: [
                { de: "Jedes BewuÃŸtsein lÃ¤ÃŸt sich nur durch drei Bestandteile denken.", ja: "ã„ã‹ãªã‚‹æ„è­˜ã‚‚ã€3ã¤ã®æ§‹æˆè¦ç´ ã«ã‚ˆã£ã¦ã®ã¿è€ƒãˆã‚‰ã‚Œã‚‹ã€‚" },
                { de: "Etwas, das sich bewuÃŸt ist, und Subjekt, etwas, dessen man sich bewuÃŸt ist, und Objekt und etwas, wodurch man sich bewuÃŸt ist, und das Vorstellung heiÃŸt.", ja: "æ„è­˜ã—ã¦ã„ã‚‹å½“ã®ã‚‚ã®ã€ã™ãªã‚ã¡ä¸»è¦³ã€æ„è­˜ã•ã‚Œã¦ã„ã‚‹å½“ã®ã‚‚ã®ã€ã™ãªã‚ã¡å®¢è¦³ã€‚ãã—ã¦ã€ãã‚Œã‚’ä»‹ã—ã¦æ„è­˜ã•ã‚Œã€è¡¨è±¡ã¨å‘¼ã°ã‚Œã‚‹ã¨ã“ã‚ã®ã‚‚ã®ã€‚" },
                { de: "Die Vorstellung ist also dasjenige, was im BewuÃŸtsein vom Subjekt und Objekt verschieden ist, aber sich auf beide bezieht.", ja: "ã—ãŸãŒã£ã¦è¡¨è±¡ã¨ã¯ã€æ„è­˜ã®ã†ã¡ã«ã‚ã£ã¦ã€ä¸»è¦³ã¨ã‚‚å®¢è¦³ã¨ã‚‚ç•°ãªã£ã¦ã„ã‚‹ã‘ã‚Œã©ã‚‚ã€ãã®ã©ã¡ã‚‰ã¨ã‚‚é–¢ä¿‚ã—ã¦ã„ã‚‹ã‚‚ã®ã§ã‚ã‚‹ã€‚" },
                { de: "Dieses ist der gemeinschaftliche Charakter der sinnlichen Vorstellung, des Begriffes (oder der Vorstellung des Verstandes) und der Idee (oder der Vorstellung der Vernunft).", ja: "ã“ã‚Œã¯ã€æ„Ÿæ€§çš„è¡¨è±¡ã€æ¦‚å¿µï¼ˆã‚ã‚‹ã„ã¯æ‚Ÿæ€§ã®è¡¨è±¡ï¼‰ã€ç†å¿µï¼ˆã‚ã‚‹ã„ã¯ç†æ€§ã®è¡¨è±¡ï¼‰ã«å…±é€šã®æ€§è³ªã§ã‚ã‚‹ã€‚" },
                { de: "Ohne diesen Charakter der Vorstellung bestimmt gedacht zu haben, wird man keine Tatsache des SelbstbewuÃŸtseins und des BewuÃŸtseins der Vorstellung bestimmt zu denken vermÃ¶gen.", ja: "è¡¨è±¡ã®ã“ã®æ€§è³ªã‚’ã‚ã‚‰ã‹ã˜ã‚æ˜ç¢ºã«è€ƒãˆã¦ãŠã‹ãªã„ã“ã¨ã«ã¯ã€è‡ªå·±æ„è­˜ã‚„è¡¨è±¡ã®æ„è­˜ã¨ã„ã£ãŸäº‹å®Ÿã‚’æ˜ç¢ºã«è€ƒãˆã‚‹ã“ã¨ã¯ã§ããªã„ã ã‚ã†ã€‚" },
                { de: "Der Satz des BewuÃŸtseins Ã¼berhaupt ist also der erste Grundsatz fÃ¼r die Wissenschaft der transzendentalen Gesetze der Erkenntnis.", ja: "ã—ãŸãŒã£ã¦ã“ã®æ„è­˜ä¸€èˆ¬ã®å‘½é¡ŒãŒã€èªè­˜ã®è¶…è¶Šè«–çš„è«¸æ³•å‰‡ã®å­¦ã«ã¨ã£ã¦ã®ç¬¬ä¸€æ ¹æœ¬å‘½é¡Œã§ã‚ã‚‹ã€‚" },
                { de: "Wenn unter Philosophie der Inbegriff der Erkenntnisse, die aus den letzten GrÃ¼nden geschÃ¶pft werden, verstanden wird; und die Erkenntnis der letzten GrÃ¼nde selbst zur Philosophie gezÃ¤hlt wird; so kann diese Erkenntnis die Elementarphilosophie heiÃŸen;", ja: "å“²å­¦ã¨ã„ã†ã“ã¨ã§ç†è§£ã•ã‚Œã¦ã„ã‚‹ã®ãŒç©¶æ¥µã®è«¸æ ¹æ‹ ã‹ã‚‰å¾—ã‚‰ã‚Œã‚‹èªè­˜ã®ç›¸å¯¾ã§ã‚ã‚‹ãªã‚‰ã°ã€ãã—ã¦ç©¶æ¥µã®æ ¹æ‹ ã®èªè­˜ãã‚Œè‡ªä½“ãŒå“²å­¦ã«æ•°ãˆã‚‰ã‚Œã‚‹ã®ã§ã‚ã‚‹ãªã‚‰ã°ã€å¾Œè€…ã®èªè­˜ã‚’æ ¹å…ƒå“²å­¦ã¨å‘¼ã¶ã“ã¨ãŒã§ãã‚‹ã€‚" },
                { de: "und der Satz des BewuÃŸtseins ist der erste Grundsatz der Elementarphilosophie.", ja: "ãã—ã¦æ„è­˜å¾‹ãŒã“ã®æ ¹å…ƒå“²å­¦ã®ç¬¬ä¸€æ ¹æœ¬å‘½é¡Œãªã®ã§ã‚ã‚‹ã€‚" }
            ],
            vocab: [
                { de: "das BewuÃŸtsein", ja: "æ„è­˜" },
                { de: "die Vorstellung", ja: "è¡¨è±¡" },
                { de: "das Subjekt", ja: "ä¸»è¦³" },
                { de: "das Objekt", ja: "å®¢è¦³" },
                { de: "der Bestandteil", ja: "æ§‹æˆè¦ç´ " },
                { de: "transzendental", ja: "è¶…è¶Šè«–çš„" }
            ]
        },
        fichte: {
            title: "FICHTE",
            subtitle: "Grundlage der gesamten Wissenschaftslehre (1794/95)",
            sentences: [
                { de: "Aller RealitÃ¤t Quelle ist das Ich.", ja: "ã™ã¹ã¦ã®å®Ÿåœ¨ã®æºæ³‰ã¯è‡ªæˆ‘ã§ã‚ã‚‹ã€‚" },
                { de: "Erst durch und mit dem Ich ist der Begriff der RealitÃ¤t gegeben.", ja: "è‡ªæˆ‘ã«ã‚ˆã£ã¦ã€ãã—ã¦è‡ªæˆ‘ã¨ã¨ã‚‚ã«åˆã‚ã¦å®Ÿåœ¨ã®æ¦‚å¿µãŒä¸ãˆã‚‰ã‚Œã‚‹ã€‚" },
                { de: "Aber das Ich ist, weil es sich setzt, und setzt sich, weil es ist.", ja: "ã—ã‹ã—ã€è‡ªæˆ‘ãŒå­˜åœ¨ã™ã‚‹ã®ã¯ãã‚ŒãŒè‡ªå·±å®šç«‹ã™ã‚‹ã‹ã‚‰ã§ã‚ã‚Šã€ãã—ã¦è‡ªæˆ‘ãŒè‡ªå·±å®šç«‹ã™ã‚‹ã®ã¯ãã‚ŒãŒå­˜åœ¨ã™ã‚‹ã‹ã‚‰ã§ã‚ã‚‹ã€‚" },
                { de: "Demnach sind sich setzen, und Sein Eins und ebendasselbe.", ja: "ã—ãŸãŒã£ã¦è‡ªå·±å®šç«‹ã¨å­˜åœ¨ã¯ã¾ã•ã«ä¸€ã¤ã®åŒã˜ã‚‚ã®ãªã®ã§ã‚ã‚‹ã€‚" },
                { de: "Aber der Begriff des Sichsetzens und der TÃ¤tigkeit Ã¼berhaupt sind wieder Eins und ebendasselbe.", ja: "ã ãŒã€è‡ªå·±å®šç«‹ã¨ã„ã†æ¦‚å¿µã¨ã€æ´»å‹•ä¸€èˆ¬ã¨ã„ã†æ¦‚å¿µã‚‚ã“ã‚Œã¾ãŸã¾ã•ã«ä¸€ã¤ã®åŒã˜ã‚‚ã®ãªã®ã§ã‚ã‚‹ã€‚" },
                { de: "Also alle RealitÃ¤t ist tÃ¤tig, und alles TÃ¤tige ist RealitÃ¤t.", ja: "ã—ãŸãŒã£ã¦ã€ã‚ã‚‰ã‚†ã‚‹ç¾å®Ÿæ€§ã¯æ´»å‹•çš„ã§ã‚ã‚Šã€ãã—ã¦ã‚ã‚‰ã‚†ã‚‹æ´»å‹•çš„ãªã‚‚ã®ã¯ç¾å®Ÿæ€§ã§ã‚ã‚‹ã€‚" },
                { de: "Es ist sehr nÃ¶tig, den Begriff der TÃ¤tigkeit sich hier ganz rein zu denken.", ja: "ãœã²ã¨ã‚‚å¿…è¦ãªã®ã¯ã€æ´»å‹•ã¨ã„ã†æ¦‚å¿µã‚’å®Œå…¨ã«ç´”ç²‹ã«è€ƒãˆã‚‹ã“ã¨ãªã®ã§ã‚ã‚‹ã€‚" },
                { de: "Es kann durch denselben nichts bezeichnet werden, was nicht in dem absoluten Setzen des Ich durch sich selbst enthalten ist; nichts, was nicht unmittelbar im Satze: Ich bin, liegt.", ja: "ã“ã®æ´»å‹•ã¨ã„ã†æ¦‚å¿µã«ã‚ˆã£ã¦ã¯ã€è‡ªæˆ‘ã®è‡ªå·±è‡ªèº«ã«ã‚ˆã‚‹çµ¶å¯¾çš„å®šç«‹ã®ã†ã¡ã«å«ã¾ã‚Œã¦ã„ãªã„ã‚‚ã®ã¯ä½•ã‚‚è¡¨ã™ã“ã¨ã¯ã§ããšã€ã€Œæˆ‘ã‚ã‚Šã€ã¨ã„ã†å‘½é¡Œã®ã†ã¡ã«ç›´æ¥å«ã¾ã‚Œã¦ã„ãªã„ã‚‚ã®ã¯ä½•ã‚‚è¡¨ã™ã“ã¨ã¯ã§ããªã„ã€‚" },
                { de: "Es ist demnach klar, dass nicht nur von allen Zeitbedingungen, sondern auch von allem Objekte der TÃ¤tigkeit vÃ¶llig zu abstrahieren ist.", ja: "ã—ãŸãŒã£ã¦æ˜ã‚‰ã‹ãªã®ã¯ã€å˜ã«æ´»å‹•ã™ã¹ã¦ã®æ™‚é–“è¦å®šã ã‘ã§ã¯ãªãã€æ´»å‹•ã®ã™ã¹ã¦ã®å®¢è¦³ã‚‚å®Œå…¨ã«æ¨è±¡ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã¨ã„ã†ã“ã¨ã§ã‚ã‚‹ã€‚" },
                { de: "Die Tathandlung des Ich, indem es sein eigenes Sein setzt, geht gar nicht auf ein Objekt, sondern sie geht in sich selbst zurÃ¼ck.", ja: "è‡ªæˆ‘ã®äº‹è¡Œã¯è‡ªå·±ãŒè‡ªæˆ‘è‡ªèº«ã®å­˜åœ¨ã‚’å®šç«‹ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€æ±ºã—ã¦å®¢è¦³ã«å‘ã‹ã†ã®ã§ã¯ãªãã‚€ã—ã‚è‡ªå·±è‡ªèº«ã®ä¸‹ã¸ã¨æˆ»ã£ã¦ã„ãã®ã§ã‚ã‚‹ã€‚" },
                { de: "Erst dann, wenn das Ich sich selbst vorstellt, wird es Objekt.", ja: "è‡ªæˆ‘ã¯ã€è‡ªæˆ‘ãŒè‡ªå·±è‡ªèº«ã‚’è¡¨è±¡ã—ã¦åˆã‚ã¦ã€è‡ªæˆ‘ã¯å®¢è¦³ã¨ãªã‚‹ã€‚" }
            ],
            vocab: [
                { de: "das Ich", ja: "è‡ªæˆ‘" },
                { de: "die Tathandlung", ja: "äº‹è¡Œ" },
                { de: "setzen", ja: "å®šç«‹ã™ã‚‹" },
                { de: "das Sein", ja: "å­˜åœ¨" },
                { de: "abstrahieren", ja: "æ¨è±¡ã™ã‚‹" }
            ]
        },
        schelling: {
            title: "SCHELLING",
            subtitle: "System des transzendentalen Idealismus (1800)",
            sentences: [
                { de: "Wenn alles Wissen auf der Ãœbereinstimmung des Subjektiven und des Objektiven beruht, so ist die Aufgabe, diese Ãœbereinstimmung zu erklÃ¤ren, ohne Zweifel die hÃ¶chste fÃ¼r alles Wissen, und wenn, wie allgemein zugestanden wird, die Philosophie die hÃ¶chste und oberste aller Wissenschaften ist, ohne Zweifel die Hauptaufgabe der Philosophie.", ja: "ã™ã¹ã¦ã®çŸ¥è­˜ãŒä¸»è¦³çš„ãªã‚‚ã®ã¨å®¢è¦³çš„ãªã‚‚ã®ã®ä¸€è‡´ã«åŸºã¥ããªã‚‰ã°ã€ã“ã®ä¸€è‡´ã‚’èª¬æ˜ã™ã‚‹ã¨ã„ã†èª²é¡Œã¯ç–‘ã„ãªãã€ã™ã¹ã¦ã®çŸ¥è­˜ã«ã¨ã£ã¦æœ€é«˜ã®èª²é¡Œã§ã‚ã‚Šã€ã¾ãŸä¸€èˆ¬çš„ã«èªã‚ã‚‰ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«å“²å­¦ãŒã™ã¹ã¦ã®å­¦ã®ä¸­ã§æœ€é«˜ã‹ã¤æœ€ä¸Šã®ã‚‚ã®ã§ã‚ã‚‹ãªã‚‰ã°ã“ã®å•é¡Œã¯ç–‘ã„ãªãå“²å­¦ã®ä¸»è¦èª²é¡Œã§ã‚ã‚‹ã€‚" },
                { de: "Das Objektive zum Ersten zu machen und das Subjektive daraus abzuleiten ist [...] Aufgabe der Natur-Philosophie.", ja: "å®¢è¦³çš„ãªã‚‚ã®ã‚’ç¬¬ä¸€ã¨ã—ã€ä¸»è¦³çš„ãªã‚‚ã®ã‚’ãã“ã‹ã‚‰å°å‡ºã™ã‚‹ã®ãŒè‡ªç„¶å“²å­¦ã®èª²é¡Œã§ã‚ã‚‹ã€‚" },
                { de: "Wenn es also eine Transzendental-Philosophie gibt, so bleibt ihr nur die entgegengesetzte Richtung Ã¼brig, vom Subjektiven als vom Ersten und Absoluten auszugehen und das Objektive aus ihm entstehen zu lassen.", ja: "ã—ãŸãŒã£ã¦è¶…è¶Šè«–å“²å­¦ã¨ã„ã†ç‰©ãŒå­˜åœ¨ã™ã‚‹ãªã‚‰ã°ã€ãã‚Œã«æ®‹ã•ã‚Œã¦ã„ã‚‹ã®ã¯åå¯¾æ–¹å‘ã€ã™ãªã‚ã¡ç¬¬ä¸€ã‹ã¤çµ¶å¯¾çš„ãªã‚‚ã®ã¨ã—ã¦ã®ä¸»è¦³çš„ãªã‚‚ã®ã‹ã‚‰å‡ºç™ºã—ã€å®¢è¦³çš„ãªã‚‚ã®ã‚’ä¸»è¦³çš„ãªã‚‚ã®ã‹ã‚‰ç”Ÿã˜ã•ã›ã‚‹ã¨ã„ã†ã“ã¨ã ã‘ã§ã‚ã‚‹ã€‚" },
                { de: "In die beiden mÃ¶glichen Richtungen der Philosophie haben sich also Natur- und Transzendental-Philosophie geteilt,", ja: "ã—ãŸãŒã£ã¦è‡ªç„¶å“²å­¦ã¨è¶…è¶Šè«–çš„å“²å­¦ã¯å“²å­¦ã®å¯èƒ½ãªæ–¹å‘ã¸ã¨åˆ¥ã‚ŒãŸã®ã§ã‚ã‚‹ã€‚" },
                { de: "und wenn alle Philosophie darauf ausgehen muÃŸ, entweder aus der Natur eine Intelligenz, oder aus der Intelligenz eine Natur zu machen, so ist die Transzendental-Philosophie, welche diese letztere Aufgabe hat, die andere notwendige Grundwissenschaft der Philosophie.", ja: "ãã—ã¦ã™ã¹ã¦ã®å“²å­¦ã¯ã€è‡ªç„¶ã‹ã‚‰çŸ¥æ€§ã‚’ä½œã‚Šå‡ºã™ã‹ã€çŸ¥æ€§ã‹ã‚‰è‡ªç„¶ã‚’ä½œã‚Šå‡ºã™ã®ã‹ã„ãšã‚Œã‹ã ã¨ã™ã‚‹ãªã‚‰ã°ã“ã®å¾Œè€…ã®èª²é¡Œã‚’ã‚‚ã¤è¶…è¶Šè«–çš„å“²å­¦ã¯å“²å­¦ã®ã‚‚ã†ä¸€æ–¹ã®å¿…ç„¶çš„ãªæ ¹æœ¬å­¦ã¨ã„ã†ã“ã¨ã«ãªã‚‹ã€‚" }
            ],
            vocab: [
                { de: "das Wissen", ja: "çŸ¥è­˜" },
                { de: "die Ãœbereinstimmung", ja: "ä¸€è‡´" },
                { de: "das Subjektive", ja: "ä¸»è¦³çš„ãªã‚‚ã®" },
                { de: "das Objektive", ja: "å®¢è¦³çš„ãªã‚‚ã®" },
                { de: "ableiten", ja: "å°å‡ºã™ã‚‹" }
            ]
        },
        hegel: {
            title: "HEGEL",
            subtitle: "PhÃ¤nomenologie des Geistes (1807)",
            sentences: [
                { de: "Das SelbstbewuÃŸtsein ist an und fÃ¼r sich, indem, und dadurch, dass es fÃ¼r ein anderes an und fÃ¼r sich ist; d. h. es ist nur als ein Anerkanntes.", ja: "è‡ªå·±æ„è­˜ãŒå³ã‹ã¤å¯¾è‡ªçš„ã«ã‚ã‚‹ã®ã¯ã€ãã‚ŒãŒå³ã‹ã¤å¯¾è‡ªçš„ã«ä»–ã®è‡ªå·±æ„è­˜ã«å¯¾ã—ã¦ã‚ã‚‹ã€ã™ãªã‚ã¡ãã‚ŒãŒæ‰¿èªã•ã‚ŒãŸã‚‚ã®ã¨ã—ã¦ã®ã¿ã‚ã‚‹æ™‚ã€ã¾ãŸãã®ã“ã¨ã«ã‚ˆã£ã¦ã§ã‚ã‚‹ã€‚" },
                { de: "Der Begriff dieser seiner Einheit in seiner Verdopplung, der sich im SelbstbewuÃŸtsein realisierenden Unendlichkeit, ist eine vielseitige und vieldeutige VerschrÃ¤nkung, so dass die Momente derselben teils genau auseinandergehalten, teils in dieser Unterscheidung zugleich auch als nicht unterschieden, oder immer in ihrer entgegengesetzten Bedeutung genommen und erkannt werden mÃ¼ssen.", ja: "ã“ã®ã‚ˆã†ã«ã€äºŒé‡åŒ–ã•ã‚ŒãªãŒã‚‰ã‚‚çµ±ä¸€ã—ã¦ãŠã‚Šã€è‡ªå·±æ„è­˜ã®ã†ã¡ã§è‡ªã‚‰ã‚’ç¾å®ŸåŒ–ã™ã‚‹ã“ã®ç„¡é™æ€§ã®æ¦‚å¿µã¯ã€å¤šãã®æ¦‚å¿µã¨å¤šãã®æ„å‘³ãŒäº¤éŒ¯ã—ãŸã‚‚ã®ã§ã‚ã‚Šã€ ãã‚Œæ•…ã€ã“ã®äº¤éŒ¯ã‚’æ§‹æˆã™ã‚‹è«¸å¥‘æ©Ÿã¯ã€å³æ ¼ã«åŒºåˆ¥ã•ã‚Œã­ã°ãªã‚‰ãªã„ä¸€æ–¹ã§ã€ ä»–æ–¹ã§ã¯ã“ã®ã‚ˆã†ã«åŒºåˆ¥ã•ã‚ŒãªãŒã‚‰ã‚‚åŒæ™‚ã«ã¾ãŸã€åŒºåˆ¥ã•ã‚Œã–ã‚‹ã‚‚ã®ã¨ã—ã¦ã€ã‚ã‚‹ã„ã¯å¸¸ã«ãã®æ­£åå¯¾ã®æ„å‘³ã§å—ã‘å–ã‚‰ã‚Œèªè­˜ã•ã‚Œã‚‹ã®ã§ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚" },
                { de: "Die Doppelsinnigkeit des Unterschiedenen liegt in dem Wesen des SelbstbewuÃŸtseins, unendlich, oder unmittelbar das Gegenteil der Bestimmtheit, in der es gesetzt ist, zu sein.", ja: "ã“ã®åŒºåˆ¥ã•ã‚ŒãŸã‚‚ã®ãŒäºŒé‡ã®æ„å‘³ã‚’ã‚‚ã¤ã¨ã„ã†ã“ã¨ã¯è‡ªå·±æ„è­˜ã®æœ¬è³ªã«å«ã¾ã‚Œã¦ã„ã‚‹ã€‚ã™ãªã‚ã¡ç„¡é™ã§ã‚ã‚‹ã€‚è‡ªå·±æ„è­˜ãŒãã®ã†ã¡ã¸ã¨ç½®ã‹ã‚Œã¦ã„ã‚‹ã¨ã“ã‚ã®è¦å®šã•ã‚Œã¦ã„ã‚‹ã¨ã“ã‚ã®æ­£åå¯¾ã§ã‚ã‚‹ã¨ã„ã†æœ¬è³ªã®ã†ã¡ã«å«ã¾ã‚Œã¦ã„ã‚‹" },
                { de: "Die Auseinanderlegung des Begriffs dieser geistigen Einheit in ihrer Verdopplung stellt uns die Bewegung des Anerkennens dar.", ja: "ã“ã†ã—ãŸäºŒé‡ã«ãªã‚ŠãªãŒã‚‰ã®ç²¾ç¥çš„çµ±ä¸€ã¨ã„ã†æ¦‚å¿µã‚’åˆ†æã™ã‚‹ã¨ã€æ‰¿èªã®é‹å‹•ãŒæˆ‘ã€…ã«è¦‹ãˆã¦ãã‚‹ã€‚" },
                { de: "Der Herr ist das fÃ¼r sich seiende BewuÃŸtsein, aber nicht mehr nur der Begriff desselben, sondern fÃ¼r sich seiendes BewuÃŸtsein, welches durch ein anderes BewuÃŸtsein mit sich vermittelt ist, nÃ¤mlich durch ein solches, zu dessen Wesen es gehÃ¶rt, dass es mit selbststÃ¤ndigem Sein oder der Dingheit Ã¼berhaupt synthesiert ist.", ja: "ä¸»äººã¯å¯¾è‡ªçš„ã«å­˜åœ¨ã™ã‚‹æ„è­˜ã§ã‚ã‚‹ã€‚ã—ã‹ã—ã€ã‚‚ã¯ã‚„ãã†ã—ãŸæ„è­˜ã®æ¦‚å¿µã«ç•™ã¾ã‚‰ãšã€ã‚ã‚‹åˆ¥ã®æ„è­˜ã«ã‚ˆã£ã¦è‡ªå·±ã¨åª’ä»‹ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªã€ã™ãªã‚ã¡è‡ªç«‹çš„ãªå­˜åœ¨ã‚‚ã—ãã¯ã€ç‰©æ€§ä¸€èˆ¬ã¨ç·åˆã•ã‚Œã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ãŒã€ãã®æœ¬è³ªã«å±ã—ã¦ã„ã‚‹ã‚ˆã†ãªã€ã‚ã‚‹ä»–ã®æ„è­˜ã«ã‚ˆã£ã¦ã€è‡ªå·±ã¨åª’ä»‹ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªã€ãã†ã„ã£ãŸå¯¾è‡ªçš„ã«å­˜åœ¨ã™ã‚‹æ„è­˜ã§ã‚ã‚‹ã€‚" },
                { de: "Der Herr bezieht sich auf den Knecht mittelbar durch das selbststÃ¤ndige Sein.", ja: "ä¸»äººã¯ã€è‡ªç«‹çš„ãªå­˜åœ¨ã‚’ä»‹ã—ã¦ã€é–“æ¥çš„ã«å¥´éš·ã¨é–¢ã‚ã‚‹ã€‚" }
            ],
            vocab: [
                { de: "an und fÃ¼r sich", ja: "å³ã‹ã¤å¯¾è‡ªçš„ã«" },
                { de: "das Anerkannte", ja: "æ‰¿èªã•ã‚ŒãŸã‚‚ã®" },
                { de: "die Verdopplung", ja: "äºŒé‡åŒ–" },
                { de: "die Unendlichkeit", ja: "ç„¡é™æ€§" },
                { de: "die VerschrÃ¤nkung", ja: "äº¤éŒ¯" }
            ]
        },
        hegel_logik: {
            title: "HEGEL",
            subtitle: "Wissenschaft der Logik (1816)",
            sentences: [
                { de: "Was die Natur des Begriffes sei, kann so wenig unmittelbar angegeben werden, als der Begriff irgend eines anderen Gegenstandes unmittelbar aufgestellt werden kann.", ja: "â‘ æ¦‚å¿µã®æœ¬æ€§ãŒä½•ã§ã‚ã‚‹ã‹ã‚’ã€ç›´æ¥çš„ã«ç¤ºã™ã“ã¨ãŒå‡ºæ¥ãªã„ã®ã¯ã€ä»–ã®ä»»æ„ã®å¯¾è±¡ã®æ¦‚å¿µã‚’ç›´æ¥çš„ã«ç¤ºã™ã“ã¨ãŒå‡ºæ¥ãªã„ã®ã¨åŒã˜ã§ã‚ã‚‹ã€‚" },
                { de: "Es kÃ¶nnte etwa scheinen, dass um den Begriff eines Gegenstandes anzugeben, das Logische vorausgesetzt werde, und dieses somit nicht wieder etwas anderes zu seinem Voraus haben, noch ein abgeleitetes sein kÃ¶nne, wie in der Geometrie logische SÃ¤tze, wie sie in Anwendung auf die GrÃ¶ÃŸe erscheinen und in dieser Wissenschaft gebraucht werden, in der Form von Axiomen, unabgeleiteten und unableitbaren Erkenntnisbestimmungen vorangeschickt werden.", ja: "â‘¡ãŸã¨ãˆã°æ¬¡ã®ã‚ˆã†ã«æ€ã‚ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€ã™ãªã‚ã¡ã€ã‚ã‚‹å¯¾è±¡ã®æ¦‚å¿µã‚’ç¤ºã™ãŸã‚ã«ã¯ã€è«–ç†çš„ãªã‚‚ã®ãŒå‰æã•ã‚Œã€ãã—ã¦ã“ã®è«–ç†çš„ãªã‚‚ã®ã¯ãã‚Œã‚†ãˆã“ã‚Œã¾ãŸä»–ã®ç‰©ã‚’å‰æã¨ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šãˆãšã€ã¾ãŸãã‚ŒãŒå°å‡ºã•ã‚ŒãŸã‚‚ã®ã§ã‚ã‚‹ã¨ã„ã†ã“ã¨ã‚‚ã‚ã‚Šãˆãªã„ã€‚ãã‚Œã¯å¹¾ä½•å­¦ã«ãŠã„ã¦ã€é‡ã«é©å¿œã•ã‚Œã¦ç¾ã‚Œã€ã“ã®å­¦å•ã®å†…ã«ä½¿ç”¨ã•ã‚Œã‚‹è«–ç†çš„ãªå‘½é¡Œã¯å…¬ç†ã¨ã„ã†å½¢å¼ã§ã™ãªã‚ã¡å°å‡ºä¸å¯èƒ½ãªèªè­˜è¦å‰‡ã¨ã„ã†å½¢å¼ã§å‰æã•ã‚Œã‚‹ã®ã¨åŒã˜ã§ã‚ã‚‹ã€‚" },
                { de: "Ob nun wohl der Begriff nicht nur als eine subjektive Voraussetzung, sondern als absolute Grundlage anzusehen ist, so kann er diese doch nicht sein, als insofern er sich zur Grundlage gemacht hat.", ja: "â‘¢ã•ã¦ã€æ¦‚å¿µã¯å˜ã«ä¸»è¦³çš„ãªå‰æã§ã¯ãªãçµ¶å¯¾çš„ãªåŸºç¤ã¨ã¿ãªã•ã‚Œãªã‘ã‚Œã°ã„ã‘ãªã„ã€ã¨ã¯ã„ãˆæ¦‚å¿µãŒè‡ªã‚‰ã‚’åŸºç¤ãŸã‚‰ã—ã‚ãŸå ´åˆã‚’é™¤ã„ã¦ã¯ã€ã‚„ã¯ã‚Šæ¦‚å¿µãŒçµ¶å¯¾çš„ãªåŸºç¤ã§ã‚ã‚‹ã“ã¨ã¯ã‚ã‚Šãˆãªã„ã€‚" },
                { de: "Das abstrakt-Unmittelbare ist wohl ein Erstes; als dieses Abstrakte, ist es aber vielmehr ein Vermitteltes, von dem also, wenn es in seiner Wahrheit gefaÃŸt werden soll, seine Grundlage erst zu suchen ist.", ja: "â‘£ç¢ºã‹ã«æŠ½è±¡çš„ã«ç›´æ¥çš„ãªã‚‚ã®ãŒç¬¬ä¸€ã®ã‚‚ã®ã§ã‚ã‚‹ã€‚ã—ã‹ã—ã“ã†ã—ãŸæŠ½è±¡çš„ãªã‚‚ã®ã¨ã—ã¦ã€ãã‚Œã¯ã‚€ã—ã‚åª’ä»‹ã•ã‚ŒãŸã‚‚ã®ã§ã‚ã‚Šã€ãã‚Œã‚†ãˆã€ã“ã®æŠ½è±¡çš„ã§ç›´æ¥çš„ãªã‚‚ã®ã‚’ãã®çœŸå®Ÿã®å§¿ã§ã¨ã‚‰ãˆã‚ˆã†ã¨ã™ã‚‹ãªã‚‰ã°ãã®åŸºç¤ã¯ã¾ãšã¯ã“ã®åª’ä»‹ã•ã‚ŒãŸã‚‚ã®ã®ã†ã¡ã«æ±‚ã‚ã‚‹ã®ã§ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚" },
                { de: "Diese muÃŸ daher zwar ein Unmittelbares sein, aber so dass es aus der Aufhebung der Vermittlung sich zum Unmittelbaren gemacht hat.", ja: "â‘¤ãã‚Œã‚†ãˆç¢ºã‹ã«ã“ã®åŸºç¤ã¯ç›´æ¥çš„ãªã‚‚ã®ã§ãªã‘ã‚Œã°ãªã‚‰ãªã„ãŒã€ã—ã‹ã—åª’ä»‹ãŒä½¿ç”¨ã•ã‚Œã‚‹ã“ã¨ã«ã‚ˆã£ã¦è‡ªã‚‰ã‚’ç›´æ¥çš„ãªã‚‚ã®ã«ã—ãŸã¨ã„ã†ã‚ˆã†ã«ã—ã¦ç›´æ¥çš„ãªã‚‚ã®ã§ãªã‘ã‚Œã°ãªã‚‰ãªã„ã®ã§ã‚ã‚‹ã€‚" }
            ],
            vocab: [
                { de: "voraussetzen", ja: "å‰æã™ã‚‹" },
                { de: "das Axiom", ja: "å…¬ç†" },
                { de: "die Grundlage", ja: "åŸºç¤" },
                { de: "unmittelbar", ja: "ç›´æ¥çš„ãª" },
                { de: "vermittelt", ja: "åª’ä»‹ã•ã‚ŒãŸ" }
            ]
        }
    };

    let currentId = 'reinhold';

    // --- Logic ---
    window.loadContent = function(id) {
        currentId = id;
        const data = allData[id];
        const progress = getProgress()[id] || {};
        const notes = getNotes()[id] || {};

        if(window.innerWidth <= 768) closeSidebar();

        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const indexMap = { 'reinhold': 0, 'fichte': 1, 'schelling': 2, 'hegel': 3, 'hegel_logik': 4 };
        document.querySelectorAll('.nav-item')[indexMap[id]].classList.add('active');

        document.getElementById('doc-title').innerHTML = data.title;
        document.getElementById('doc-subtitle').innerText = data.subtitle;
        document.getElementById('mobile-title').innerText = data.title;

        const container = document.getElementById('parallelText');
        container.innerHTML = '';
        
        data.sentences.forEach((sent, index) => {
            const div = document.createElement('div');
            
            // Apply status classes
            let statusClass = '';
            if (progress[index]) {
                statusClass = progress[index].isPassed ? 'passed' : 'failed';
            }
            div.className = `sentence-group ${statusClass}`;
            
            // Note value
            const noteValue = notes[index] || "";
            const noteVisibleClass = noteValue ? 'visible' : '';
            
            div.innerHTML = `
                <div class="de-text-row">
                    <div class="de-text">${sent.de}</div>
                    <button class="btn-speak" onclick="speakText('${sent.de.replace(/'/g, "\\'")}')">ğŸ”ˆ</button>
                </div>
                <!-- Japanese Text Area with Toggle Class -->
                <div class="ja-text" onclick="toggleReveal(this)">
                    ${sent.ja}
                </div>
                <div class="action-row">
                    <button class="btn-action-minimal" onclick="explainSentence(${index})">
                        <span>â—</span> ANALYZE
                    </button>
                    <button class="btn-action-minimal" onclick="toggleNote(${index})">
                        <span>â—</span> NOTE
                    </button>
                </div>
                
                <div class="note-area ${noteVisibleClass}" id="note-area-${index}">
                    <textarea class="note-input" id="note-input-${index}" placeholder="Write your notes here..." oninput="saveNoteHandler(${index}, this.value)">${noteValue}</textarea>
                </div>

                <div class="ai-analysis" id="ai-response-${index}">
                    <div class="ai-body"></div>
                </div>
            `;
            
            div.addEventListener('click', (e) => {
                if(e.target.closest('button') || e.target.closest('textarea')) return;
                document.querySelectorAll('.sentence-group').forEach(p => p.classList.remove('active'));
                div.classList.add('active');
            });

            container.appendChild(div);
        });

        const vocabGrid = document.getElementById('vocabGrid');
        vocabGrid.innerHTML = '';
        data.vocab.forEach(v => {
            const item = document.createElement('div');
            item.className = 'vocab-item';
            item.innerHTML = `<span class="vocab-de">${v.de}</span><span class="vocab-ja">${v.ja}</span>`;
            vocabGrid.appendChild(item);
        });
        
        window.scrollTo(0, 0);
    }

    // --- Sidebar & UI Logic ---
    window.toggleSidebar = function() {
        document.getElementById('sidebar').classList.add('open');
        document.getElementById('sidebarOverlay').classList.add('open');
    }
    window.closeSidebar = function() {
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('sidebarOverlay').classList.remove('open');
    }
    window.toggleFab = function() { document.getElementById('fabContainer').classList.toggle('active'); }

    // --- Hidden Mode Logic (New!) ---
    window.toggleHiddenMode = function() {
        const eyeIconPath = document.querySelector("#icon-eye-toggle path");
        const eyeIconCircle = document.querySelector("#icon-eye-toggle circle");
        
        document.body.classList.toggle('hidden-mode');
        
        // Toggle icon state
        if (document.body.classList.contains('hidden-mode')) {
             // Closed eye / slashed eye path
             eyeIconPath.setAttribute("d", "M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24");
             eyeIconCircle.style.display = 'none';
             // Add strike-through line to SVG manually if needed or swap whole SVG
             document.getElementById("icon-eye-toggle").innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
        } else {
             // Open eye path
             document.getElementById("icon-eye-toggle").innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
        }

        // Reset all revealed items when toggling mode
        document.querySelectorAll('.ja-text.revealed').forEach(el => el.classList.remove('revealed'));
    }

    window.toggleReveal = function(element) {
        if (document.body.classList.contains('hidden-mode')) {
            element.classList.toggle('revealed');
        }
    }

    // Notes Logic
    window.toggleNote = function(index) {
        document.getElementById(`note-area-${index}`).classList.toggle('visible');
    }
    window.saveNoteHandler = function(index, text) {
        saveNote(currentId, index, text);
    }

    // Text to Speech
    window.speakText = function(text) {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'de-DE';
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        } else {
            alert("ãƒ–ãƒ©ã‚¦ã‚¶ãŒéŸ³å£°èª­ã¿ä¸Šã’ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
        }
    }

    // Search Feature
    window.openSearchModal = function() {
        document.getElementById('searchModal').classList.add('active');
        document.getElementById('searchModal').style.display = 'flex';
        document.getElementById('searchInput').focus();
    }

    window.performSearch = function() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const resultsContainer = document.getElementById('searchResults');
        resultsContainer.innerHTML = '';

        if (query.length < 2) return;

        Object.keys(allData).forEach(key => {
            const doc = allData[key];
            doc.sentences.forEach((sent, idx) => {
                if (sent.de.toLowerCase().includes(query) || sent.ja.includes(query)) {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.innerHTML = `
                        <div class="result-source">${doc.title}</div>
                        <div class="result-text">${sent.de.substring(0, 60)}...</div>
                    `;
                    item.onclick = () => {
                        loadContent(key);
                        closeModal('searchModal');
                        setTimeout(() => {
                            const el = document.querySelectorAll('.sentence-group')[idx];
                            if(el) {
                                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                el.classList.add('active');
                            }
                        }, 100);
                    };
                    resultsContainer.appendChild(item);
                }
            });
        });
    }

    // AI Chat
    window.openChatModal = function() { document.getElementById('chatModal').classList.add('active'); document.getElementById('chatModal').style.display = 'flex'; }
    window.sendMessage = async function() {
        const input = document.getElementById('chatInput');
        const container = document.getElementById('chatContainer');
        const text = input.value.trim();
        if(!text) return;
        const userDiv = document.createElement('div'); userDiv.className = 'chat-message user'; userDiv.textContent = text; container.appendChild(userDiv);
        input.value = ''; container.scrollTop = container.scrollHeight;
        const aiDiv = document.createElement('div'); aiDiv.className = 'chat-message ai'; aiDiv.innerHTML = '<span class="loader"></span> Thinking...'; container.appendChild(aiDiv);
        container.scrollTop = container.scrollHeight;
        const prompt = `You are a wise philosophy tutor specializing in German Idealism. User Question: "${text}". Answer in Japanese politely and concisely.`;
        try { const result = await model.generateContent(prompt); const response = result.response.text(); aiDiv.innerHTML = response.replace(/\n/g, '<br>'); } catch (e) { aiDiv.textContent = "Error: " + e.message; }
        container.scrollTop = container.scrollHeight;
    }

    // Explain
    window.explainSentence = async function(index) {
        const responseBox = document.getElementById(`ai-response-${index}`);
        const contentDiv = responseBox.querySelector('.ai-body');
        const btn = document.getElementById(`explain-btn-${index}`);
        if (responseBox.classList.contains('visible')) { responseBox.classList.remove('visible'); return; }
        responseBox.classList.add('visible'); contentDiv.innerHTML = '<span class="loader"></span> Thinking...'; btn.disabled = true;
        const sent = allData[currentId].sentences[index];
        const prompt = `
            ã‚ãªãŸã¯å„ªç§€ãªãƒ‰ã‚¤ãƒ„èªæ•™å¸«ã§ã™ã€‚ä»¥ä¸‹ã®æ–‡ã‚’æ—¥æœ¬èªã§æ–‡æ³•çš„ã«åˆ†æã—ã¦ãã ã•ã„ã€‚
            ãƒ‰ã‚¤ãƒ„èª: "${sent.de}"
            æ—¥æœ¬èªè¨³: "${sent.ja}"

            å‡ºåŠ›ã¯ä»¥ä¸‹ã®HTMLå½¢å¼ã®ã¿ï¼ˆMarkdownãªã—ã€å¿…ãšæ—¥æœ¬èªã§ï¼‰ï¼š
            <h3>ğŸ“ æ§‹æ–‡è§£æ</h3>
            <ul><li>ä¸»èªãƒ»è¿°èªãƒ»ç›®çš„èªã®ç‰¹å®š</li><li>é–¢ä¿‚ä»£åè©ã‚„æ¥ç¶šè©ã®æ©Ÿèƒ½</li></ul>
            <h3>ğŸ“– é‡è¦è¡¨ç¾</h3>
            <ul><li><code>å˜èª</code>: æ„å‘³ã¨è§£èª¬</li></ul>
            <h3>ğŸ’¡ ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h3>
            <p>ç¿»è¨³ã®ã‚³ãƒ„ã‚„æ³¨æ„ç‚¹</p>
        `;
        try { const result = await model.generateContent(prompt); contentDiv.innerHTML = result.response.text(); } catch (error) { contentDiv.innerHTML = `<span style="color:#d4af37">Error: ${error.message}</span>`; } finally { btn.disabled = false; }
    }

    // Quiz Logic with Priorities
    let currentQuizQuestions = [];
    let currentQuizIndices = []; 

    window.generateTranslationQuiz = async function() {
        const modal = document.getElementById('quizModal');
        const container = document.getElementById('quizContainer');
        modal.classList.add('active'); modal.style.display = 'flex';
        container.innerHTML = '<div style="text-align:center; padding:40px; color:#d4af37; font-family:\'Montserrat\'"><span class="loader"></span> GENERATING QUIZ...</div>';

        // Select questions based on progress
        const progress = getProgress()[currentId] || {};
        const sentences = allData[currentId].sentences;
        
        let targetIndices = [];
        const notAttempted = [];
        const failed = [];
        const passed = [];

        sentences.forEach((_, idx) => {
            if (!progress[idx]) {
                notAttempted.push(idx);
            } else if (!progress[idx].isPassed) {
                failed.push(idx);
            } else {
                passed.push(idx);
            }
        });

        // Priority: Not Attempted > Failed > Passed
        if (notAttempted.length > 0) {
            targetIndices = notAttempted.slice(0, 2);
        } else if (failed.length > 0) {
            targetIndices = failed.slice(0, 2);
        } else {
            targetIndices = passed.sort(() => 0.5 - Math.random()).slice(0, 2);
        }
        
        currentQuizIndices = targetIndices;

        const targetSentencesText = targetIndices.map(idx => `Sentence ${idx + 1}: ${sentences[idx].de}`).join("\n");
        const prompt = `
            Create descriptive translation questions based on these specific German sentences.
            ${targetSentencesText}
            
            Return ONLY a raw JSON array matching the input order:
            [
                {
                    "german_text": "The German sentence provided",
                    "reference_translation": "Japanese translation"
                }
            ]
        `;

        try {
            const result = await model.generateContent(prompt);
            let text = result.response.text().replace(/```json/g, '').replace(/```/g, '').trim();
            currentQuizQuestions = JSON.parse(text);
            renderQuiz(currentQuizQuestions);
        } catch (error) {
            container.innerHTML = `<div style="color:#d4af37">Error: ${error.message}</div>`;
        }
    }

    function renderQuiz(questions) {
        const container = document.getElementById('quizContainer');
        container.innerHTML = '';
        questions.forEach((q, index) => {
            const div = document.createElement('div');
            div.className = 'quiz-card';
            div.innerHTML = `
                <p style="font-family:'Montserrat'; font-size:0.8rem; color:#888; margin-bottom:10px;">QUESTION 0${index + 1}</p>
                <div class="source-text">${q.german_text}</div>
                <textarea id="user-ans-${index}" class="translation-input" placeholder="æ—¥æœ¬èªè¨³ã‚’å…¥åŠ›..."></textarea>
                <button class="btn-grade" onclick="gradeAnswer(${index})">SUBMIT</button>
                <div id="feedback-${index}" style="margin-top:20px;"></div>
            `;
            container.appendChild(div);
        });
    }

    window.gradeAnswer = async function(index) {
        const userAns = document.getElementById(`user-ans-${index}`).value;
        const feedbackDiv = document.getElementById(`feedback-${index}`);
        const qData = currentQuizQuestions[index];
        const sentenceIndex = currentQuizIndices[index];

        if(!userAns) return;

        feedbackDiv.innerHTML = '<span style="color:#d4af37; font-size:0.8rem; font-family:\'Montserrat\'">GRADING...</span>';
        
        const prompt = `
            Grade translation. Original: "${qData.german_text}". Student: "${userAns}". Reference: "${qData.reference_translation}".
            Return JSON: { "score": 80, "feedback": "Japanese feedback" }
        `;

        try {
            const result = await model.generateContent(prompt);
            const data = JSON.parse(result.response.text().replace(/```json/g, '').replace(/```/g, '').trim());
            
            // Save Progress
            saveProgress(currentId, sentenceIndex, data.score);
            
            // Update view after short delay to show status
            setTimeout(() => loadContent(currentId), 2000); 

            feedbackDiv.innerHTML = `
                <div style="border:1px solid #333; padding:20px;">
                    <div style="font-family:'Cinzel'; font-size:1.2rem; color:${data.score >= 80 ? '#2e7d32' : '#c62828'}">SCORE: ${data.score}</div>
                    <p style="font-size:0.9rem; margin:15px 0; line-height:1.8;">${data.feedback}</p>
                    <div style="font-size:0.8rem; color:#666; border-top:1px solid #222; padding-top:10px; margin-top:10px;">
                        MODEL: ${qData.reference_translation}
                    </div>
                </div>
            `;
        } catch (e) {
            feedbackDiv.innerHTML = "Error grading.";
        }
    }

    window.closeModal = function(id) {
        document.getElementById(id).classList.remove('active');
        setTimeout(() => { document.getElementById(id).style.display = 'none'; }, 300);
        if(id === 'quizModal') loadContent(currentId);
    }

    loadContent('reinhold');
</script>

</body>
</html>
